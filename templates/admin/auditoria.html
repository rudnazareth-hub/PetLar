{% extends "base_privada.html" %}

{% block titulo %}Auditoria de Logs{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-journal-text"></i> Auditoria de Logs</h2>
            <a href="/usuario" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
            </a>
        </div>

        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i>
            Visualize e filtre os logs do sistema por data e nível de severidade.
            Os logs são armazenados diariamente no formato <code>app.YYYY.MM.DD.log</code>.
        </div>

        <!-- Formulário de Filtros -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="POST" action="/admin/auditoria/filtrar" id="formFiltro">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="data" class="form-label">
                                <i class="bi bi-calendar3"></i> Data do Log
                            </label>
                            <input type="date" class="form-control" id="data" name="data" value="{{ data_selecionada }}"
                                required>
                        </div>

                        <div class="col-md-4">
                            <label for="nivel" class="form-label">
                                <i class="bi bi-funnel"></i> Nível de Log
                            </label>
                            <select class="form-select" id="nivel" name="nivel">
                                <option value="TODOS" {{ 'selected' if nivel_selecionado=='TODOS' else '' }}>Todos os
                                    Níveis</option>
                                <option value="DEBUG" {{ 'selected' if nivel_selecionado=='DEBUG' else '' }}>DEBUG
                                </option>
                                <option value="INFO" {{ 'selected' if nivel_selecionado=='INFO' else '' }}>INFO</option>
                                <option value="WARNING" {{ 'selected' if nivel_selecionado=='WARNING' else '' }}>WARNING
                                </option>
                                <option value="ERROR" {{ 'selected' if nivel_selecionado=='ERROR' else '' }}>ERROR
                                </option>
                                <option value="CRITICAL" {{ 'selected' if nivel_selecionado=='CRITICAL' else '' }}>
                                    CRITICAL</option>
                            </select>
                        </div>

                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Filtrar Logs
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resultado dos Logs -->
        {% if logs is defined %}
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text"></i> Resultados
                    </h5>
                    <span class="badge bg-light text-primary">
                        {{ total_linhas }} linha{{ 's' if total_linhas != 1 else '' }} encontrada{{ 's' if total_linhas
                        != 1 else '' }}
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if logs %}
                <textarea readonly class="form-control font-monospace border-0 rounded-0 resize-none fs-small lh-sm" rows="25">{{ logs }}</textarea>
                {% else %}
                <div class="alert alert-warning mb-0 rounded-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    {{ mensagem_erro if mensagem_erro else 'Nenhum log encontrado para os filtros selecionados.' }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Limitar data máxima a hoje
    document.addEventListener('DOMContentLoaded', function () {
        const inputData = document.getElementById('data');
        const hoje = new Date().toISOString().split('T')[0];
        inputData.setAttribute('max', hoje);

        // Se não houver data selecionada, definir como hoje
        if (!inputData.value) {
            inputData.value = hoje;
        }
    });

    // Auto-submit ao mudar filtros (opcional - pode ser removido se preferir)
    // document.getElementById('nivel').addEventListener('change', function() {
    //     document.getElementById('formFiltro').submit();
    // });
</script>
{% endblock %}