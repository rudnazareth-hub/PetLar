{% extends 'base_privada.html' %}

{% block titulo %}Gerenciar Chamados{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-headset"></i> Gerenciar Chamados</h2>
            </div>

            {% if chamados %}
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">#</th>
                                    <th>Título</th>
                                    <th style="width: 150px;">Usuário</th>
                                    <th style="width: 120px;">Status</th>
                                    <th style="width: 120px;">Prioridade</th>
                                    <th style="width: 150px;">Data Abertura</th>
                                    <th style="width: 200px;" class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for chamado in chamados %}
                                <tr>
                                    <td><strong>#{{ chamado.id }}</strong></td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;" title="{{ chamado.titulo }}">
                                            {{ chamado.titulo }}
                                        </div>
                                        <!-- Badge de Mensagens Não Lidas -->
                                        {% if chamado.mensagens_nao_lidas > 0 %}
                                        <span class="badge bg-warning text-dark mt-1">
                                            <i class="bi bi-envelope-fill"></i>
                                            {{ chamado.mensagens_nao_lidas }} não lida{% if chamado.mensagens_nao_lidas > 1 %}s{% endif %}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="d-block">{{ chamado.usuario_nome }}</small>
                                        <small class="text-muted">{{ chamado.usuario_email }}</small>
                                    </td>
                                    <td>
                                        {% if chamado.status.value == 'Aberto' %}
                                        <span class="badge bg-primary">{{ chamado.status.value }}</span>
                                        {% elif chamado.status.value == 'Em Análise' %}
                                        <span class="badge bg-info">{{ chamado.status.value }}</span>
                                        {% elif chamado.status.value == 'Resolvido' %}
                                        <span class="badge bg-success">{{ chamado.status.value }}</span>
                                        {% elif chamado.status.value == 'Fechado' %}
                                        <span class="badge bg-secondary">{{ chamado.status.value }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if chamado.prioridade.value == 'Urgente' %}
                                        <span class="badge bg-danger">{{ chamado.prioridade.value }}</span>
                                        {% elif chamado.prioridade.value == 'Alta' %}
                                        <span class="badge bg-warning text-dark">{{ chamado.prioridade.value }}</span>
                                        {% elif chamado.prioridade.value == 'Média' %}
                                        <span class="badge bg-info">{{ chamado.prioridade.value }}</span>
                                        {% elif chamado.prioridade.value == 'Baixa' %}
                                        <span class="badge bg-secondary">{{ chamado.prioridade.value }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ chamado.data_abertura|format_data }}</small>
                                        <small class="d-block text-muted">{{ chamado.data_abertura|format_hora }}</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="/admin/chamados/{{ chamado.id }}/responder"
                                               class="btn btn-primary"
                                               title="Responder chamado">
                                                <i class="bi bi-reply"></i>
                                            </a>
                                            {% if chamado.status.value == 'Fechado' %}
                                            <button type="button"
                                                    class="btn btn-success"
                                                    title="Reabrir chamado"
                                                    onclick="reabrirChamado({{ chamado.id }}, '{{ chamado.titulo|replace("'", "\\'") }}')">
                                                <i class="bi bi-arrow-counterclockwise"></i>
                                            </button>
                                            {% else %}
                                            <button type="button"
                                                    class="btn btn-secondary"
                                                    title="Fechar chamado"
                                                    onclick="fecharChamado({{ chamado.id }}, '{{ chamado.titulo|replace("'", "\\'") }}')">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <small class="text-muted">
                    Total: {{ chamados|length }} chamado(s)
                    {% set pendentes = chamados|selectattr('status.value', 'in', ['Aberto', 'Em Análise'])|list %}
                    {% if pendentes %}
                    | Pendentes: <strong class="text-danger">{{ pendentes|length }}</strong>
                    {% endif %}
                    {% set resolvidos = chamados|selectattr('status.value', 'equalto', 'Resolvido')|list %}
                    {% if resolvidos %}
                    | Resolvidos: <strong class="text-success">{{ resolvidos|length }}</strong>
                    {% endif %}
                </small>
            </div>
            {% else %}
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading"><i class="bi bi-info-circle"></i> Nenhum chamado encontrado</h4>
                <p>Ainda não há chamados abertos no sistema.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% include 'components/modal_confirmacao.html' %}
{% endblock %}

{% block scripts %}
<script>
    function fecharChamado(chamadoId, chamadoTitulo) {
        const detalhes = `
        <div class="card bg-light border-secondary">
            <div class="card-body">
                <h6 class="card-title mb-2">
                    <i class="bi bi-ticket-detailed"></i> Chamado #${chamadoId}:
                </h6>
                <p class="mb-0"><strong>${chamadoTitulo}</strong></p>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> O chamado será fechado sem adicionar uma nova mensagem.
                    <br>O usuário será notificado sobre o fechamento.
                </small>
            </div>
        </div>
    `;

        abrirModalConfirmacao({
            url: `/admin/chamados/${chamadoId}/fechar`,
            tipo: 'warning',
            titulo: 'Confirmar Fechamento',
            icone: 'bi-lock-fill',
            mensagem: 'Tem certeza que deseja fechar este chamado?',
            detalhes: detalhes,
            btnTexto: 'Fechar Chamado',
            btnIcone: 'bi-lock-fill',
            avisoTexto: 'Esta ação pode ser revertida reabrindo o chamado.'
        });
    }

    function reabrirChamado(chamadoId, chamadoTitulo) {
        const detalhes = `
        <div class="card bg-light border-success">
            <div class="card-body">
                <h6 class="card-title mb-2">
                    <i class="bi bi-ticket-detailed"></i> Chamado #${chamadoId}:
                </h6>
                <p class="mb-0"><strong>${chamadoTitulo}</strong></p>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> O chamado será reaberto com status "Em Análise".
                    <br>O usuário poderá adicionar novas mensagens ao chamado.
                </small>
            </div>
        </div>
    `;

        abrirModalConfirmacao({
            url: `/admin/chamados/${chamadoId}/reabrir`,
            tipo: 'success',
            titulo: 'Confirmar Reabertura',
            icone: 'bi-arrow-counterclockwise',
            mensagem: 'Tem certeza que deseja reabrir este chamado?',
            detalhes: detalhes,
            btnTexto: 'Reabrir Chamado',
            btnIcone: 'bi-arrow-counterclockwise',
            avisoTexto: 'O chamado voltará ao status "Em Análise".'
        });
    }
</script>
{% endblock %}
