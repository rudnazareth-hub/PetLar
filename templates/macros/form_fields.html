{#
Macro para criar campos de formulário com Bootstrap 5

Uso:
{% from "macros/form_fields.html" import field %}
{{ field(name='email', label='E-mail', type='email', required=true) }}
#}

{% macro field(
name,
label,
type='text',
value=None,
placeholder=None,
required=false,
autofocus=false,
disabled=false,
readonly=false,
rows=3,
options=none,
class_extra='',
help_text='',
id=none,
attributes=none,
append_icon=none,
append_button_onclick='',
radio_style='default',
radio_layout='vertical',
radio_icons=none,
checkbox_style='default',
wrapper_class='',
mask=none,
unmask=false,
oninput=none,
onchange=none,
onblur=none,
onfocus=none,
onkeyup=none,
onkeydown=none,
onpaste=none,
decimal_places=2,
show_thousands=true,
allow_negative=false,
decimal_prefix='',
decimal_suffix=''
) %}

{# Variáveis internas #}
{% set field_id = id or name %}
{% set field_error = erros[name] if erros is defined and name in erros else none %}
{% set field_value = value if value is not none else (dados[name] if dados is defined and name in dados else '') %}
{% set field_placeholder = placeholder or label %}
{% set has_error = field_error is not none %}

{# Atributos HTML extras #}
{% set extra_attrs = attributes or {} %}

{# Adicionar atributos de máscara se fornecidos #}
{% if mask %}
{% set _ = extra_attrs.update({'data-mask': mask}) %}
{% if unmask %}
{% set _ = extra_attrs.update({'data-unmask': 'true'}) %}
{% endif %}
{% endif %}

{# Adicionar eventos JavaScript se fornecidos #}
{% if oninput %}
{% set _ = extra_attrs.update({'oninput': oninput}) %}
{% endif %}
{% if onchange %}
{% set _ = extra_attrs.update({'onchange': onchange}) %}
{% endif %}
{% if onblur %}
{% set _ = extra_attrs.update({'onblur': onblur}) %}
{% endif %}
{% if onfocus %}
{% set _ = extra_attrs.update({'onfocus': onfocus}) %}
{% endif %}
{% if onkeyup %}
{% set _ = extra_attrs.update({'onkeyup': onkeyup}) %}
{% endif %}
{% if onkeydown %}
{% set _ = extra_attrs.update({'onkeydown': onkeydown}) %}
{% endif %}
{% if onpaste %}
{% set _ = extra_attrs.update({'onpaste': onpaste}) %}
{% endif %}

{# Adicionar atributos decimais se type='decimal' #}
{% if type == 'decimal' %}
{% set _ = extra_attrs.update({'data-decimal': 'true'}) %}
{% set _ = extra_attrs.update({'data-decimal-places': decimal_places|string}) %}
{% set _ = extra_attrs.update({'data-show-thousands': 'true' if show_thousands else 'false'}) %}
{% if allow_negative %}
{% set _ = extra_attrs.update({'data-allow-negative': 'true'}) %}
{% endif %}
{% if decimal_prefix %}
{% set _ = extra_attrs.update({'data-decimal-prefix': decimal_prefix}) %}
{% endif %}
{% if decimal_suffix %}
{% set _ = extra_attrs.update({'data-decimal-suffix': decimal_suffix}) %}
{% endif %}
{% endif %}

{# Tipos de campo que usam form-floating #}
{% set floating_types = ['text', 'email', 'password', 'tel', 'url', 'search', 'number',
'date', 'time', 'datetime-local', 'month', 'week', 'color', 'file'] %}

{# ========== HIDDEN INPUT ========== #}
{% if type == 'hidden' %}
<input type="hidden" id="{{ field_id }}" name="{{ name }}" value="{{ field_value }}">

{# ========== CHECKBOX ========== #}
{% elif type == 'checkbox' %}
<div class="{{ wrapper_class }}">
    <div class="form-check {% if checkbox_style == 'switch' %}form-switch{% endif %}">
        <input class="form-check-input {{ class_extra }} {% if has_error %}is-invalid{% endif %}" type="checkbox"
            id="{{ field_id }}" name="{{ name }}" value="1" {% if field_value or (field_value|string=='1' ) or
            (field_value|string=='True' ) %}checked{% endif %} {% if disabled %}disabled{% endif %} {% if readonly
            %}readonly{% endif %} {% if required %}required{% endif %} {% if autofocus %}autofocus{% endif %} {% for
            attr, attr_value in extra_attrs.items() %}{{ attr }}="{{ attr_value }}" {% endfor %}>
        <label class="form-check-label" for="{{ field_id }}">
            {{ label }}
        </label>
        {% if has_error %}
        <div class="invalid-feedback">
            {{ field_error }}
        </div>
        {% endif %}
    </div>
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
</div>

{# ========== RADIO BUTTONS ========== #}
{% elif type == 'radio' %}
<div class="{{ wrapper_class }}">
    {% if radio_style == 'buttons' %}
    {# Estilo button-group #}
    {% if label %}
    <label class="form-label">{{ label }}</label>
    {% endif %}
    <div class="btn-group btn-group-secondary w-100" role="group">
        {% for option_value, option_label in options.items() %}
        <input type="radio" class="btn-check" name="{{ name }}" id="{{ field_id }}_{{ option_value }}"
            value="{{ option_value }}" {% if field_value|string==option_value|string %}checked{% endif %} {% if disabled
            %}disabled{% endif %} {% if required %}required{% endif %} {% if autofocus and loop.first %}autofocus{%
            endif %} {% for attr, attr_value in extra_attrs.items() %}{{ attr }}="{{ attr_value }}" {% endfor %}>
        {% if radio_icons and option_value in radio_icons %}
        {# Botão com ícone #}
        <label class="btn btn-outline-primary d-flex flex-column align-items-center py-2"
            for="{{ field_id }}_{{ option_value }}">
            <i class="bi {{ radio_icons[option_value] }} fs-1 mb-0"></i>
            <span>{{ option_label }}</span>
        </label>
        {% else %}
        {# Botão sem ícone #}
        <label class="btn btn-outline-primary" for="{{ field_id }}_{{ option_value }}">
            {{ option_label }}
        </label>
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    {# Estilo padrão form-check #}
    <label class="form-label">{{ label }}</label>
    {% if radio_layout == 'horizontal' %}
    {# Layout horizontal #}
    <div class="d-flex flex-wrap gap-3">
        {% for option_value, option_label in options.items() %}
        <div class="form-check">
            <input class="form-check-input {{ class_extra }} {% if has_error %}is-invalid{% endif %}" type="radio"
                name="{{ name }}" id="{{ field_id }}_{{ option_value }}" value="{{ option_value }}" {% if
                field_value|string==option_value|string %}checked{% endif %} {% if disabled %}disabled{% endif %} {% if
                required %}required{% endif %} {% if autofocus and loop.first %}autofocus{% endif %} {% for attr,
                attr_value in extra_attrs.items() %}{{ attr }}="{{ attr_value }}" {% endfor %}>
            <label class="form-check-label" for="{{ field_id }}_{{ option_value }}">
                {{ option_label }}
            </label>
        </div>
        {% endfor %}
    </div>
    {% else %}
    {# Layout vertical (padrão) #}
    {% for option_value, option_label in options.items() %}
    <div class="form-check">
        <input class="form-check-input {{ class_extra }} {% if has_error %}is-invalid{% endif %}" type="radio"
            name="{{ name }}" id="{{ field_id }}_{{ option_value }}" value="{{ option_value }}" {% if
            field_value|string==option_value|string %}checked{% endif %} {% if disabled %}disabled{% endif %} {% if
            required %}required{% endif %} {% if autofocus and loop.first %}autofocus{% endif %} {% for attr, attr_value
            in extra_attrs.items() %}{{ attr }}="{{ attr_value }}" {% endfor %}>
        <label class="form-check-label" for="{{ field_id }}_{{ option_value }}">
            {{ option_label }}
        </label>
    </div>
    {% endfor %}
    {% endif %}
    {% endif %}
    {% if has_error %}
    <div class="invalid-feedback d-block">
        {{ field_error }}
    </div>
    {% endif %}
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
</div>

{# ========== TEXTAREA ========== #}
{% elif type == 'textarea' %}
<div class="{{ wrapper_class }}">
    <div class="form-floating">
        <textarea class="form-control {{ class_extra }} {% if has_error %}is-invalid{% endif %}" id="{{ field_id }}"
            name="{{ name }}" placeholder="{{ field_placeholder }}" style="height: {{ rows * 30 }}px;" {% if disabled
            %}disabled{% endif %} {% if readonly %}readonly{% endif %} {% if required %}required{% endif %} {% if
            autofocus %}autofocus{% endif %} {% for attr, attr_value in extra_attrs.items() %}{{ attr
            }}="{{ attr_value }}" {% endfor %}>{{ field_value }}</textarea>
        <label for="{{ field_id }}">{{ label }}</label>
        {% if has_error %}
        <div class="invalid-feedback">
            {{ field_error }}
        </div>
        {% endif %}
    </div>
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
</div>

{# ========== SELECT ========== #}
{% elif type == 'select' %}
<div class="{{ wrapper_class }}">
    <div class="form-floating">
        <select class="form-select {{ class_extra }} {% if has_error %}is-invalid{% endif %}" id="{{ field_id }}"
            name="{{ name }}" {% if disabled %}disabled{% endif %} {% if required %}required{% endif %} {% if autofocus
            %}autofocus{% endif %} {% for attr, attr_value in extra_attrs.items() %}{{ attr }}="{{ attr_value }}" {%
            endfor %}>
            {% if not required %}
            <option value="">Selecione...</option>
            {% endif %}
            {% for option_value, option_label in options.items() %}
            <option value="{{ option_value }}" {% if field_value|string==option_value|string %}selected{% endif %}>
                {{ option_label }}
            </option>
            {% endfor %}
        </select>
        <label for="{{ field_id }}">{{ label }}</label>
        {% if has_error %}
        <div class="invalid-feedback">
            {{ field_error }}
        </div>
        {% endif %}
    </div>
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
</div>

{# ========== DECIMAL INPUT ========== #}
{% elif type == 'decimal' %}
<div class="{{ wrapper_class }}">
    <div class="form-floating">
        <input type="text" class="form-control {{ class_extra }} {% if has_error %}is-invalid{% endif %}"
            id="{{ field_id }}" name="{{ name }}" value="{{ field_value }}" placeholder="{{ field_placeholder }}" {% if
            disabled %}disabled{% endif %} {% if readonly %}readonly{% endif %} {% if required %}required{% endif %} {%
            if autofocus %}autofocus{% endif %} {% for attr, attr_value in extra_attrs.items() %}{{ attr
            }}="{{ attr_value }}" {% endfor %}>
        <label for="{{ field_id }}">{{ label }}</label>
        {% if has_error %}
        <div class="invalid-feedback">
            {{ field_error }}
        </div>
        {% endif %}
    </div>
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
</div>

{# ========== INPUT COM BOTÃO ANEXADO (input-group) ========== #}
{% elif append_icon %}
<div class="{{ wrapper_class }}">
    <div class="input-group">
        <div class="form-floating">
            <input type="{{ type }}" class="form-control {{ class_extra }} {% if has_error %}is-invalid{% endif %}"
                id="{{ field_id }}" name="{{ name }}" value="{{ field_value }}" placeholder="{{ field_placeholder }}" {%
                if disabled %}disabled{% endif %} {% if readonly %}readonly{% endif %} {% if required %}required{% endif
                %} {% if autofocus %}autofocus{% endif %} {% for attr, attr_value in extra_attrs.items() %}{{ attr
                }}="{{ attr_value }}" {% endfor %}>
            <label for="{{ field_id }}">{{ label }}</label>
        </div>
        <button class="btn btn-outline-secondary" type="button" onclick="{{ append_button_onclick }}">
            <i class="bi {{ append_icon }}"></i>
        </button>
        {% if has_error %}
        <div class="invalid-feedback">
            {{ field_error }}
        </div>
        {% endif %}
    </div>
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
</div>

{# ========== INPUT PADRÃO (text, email, password, date, etc.) ========== #}
{% elif type in floating_types %}
<div class="{{ wrapper_class }}">
    <div class="form-floating">
        <input type="{{ type }}" class="form-control {{ class_extra }} {% if has_error %}is-invalid{% endif %}"
            id="{{ field_id }}" name="{{ name }}" value="{{ field_value }}" placeholder="{{ field_placeholder }}" {% if
            disabled %}disabled{% endif %} {% if readonly %}readonly{% endif %} {% if required %}required{% endif %} {%
            if autofocus %}autofocus{% endif %} {% for attr, attr_value in extra_attrs.items() %}{{ attr
            }}="{{ attr_value }}" {% endfor %}>
        <label for="{{ field_id }}">{{ label }}</label>
        {% if has_error %}
        <div class="invalid-feedback">
            {{ field_error }}
        </div>
        {% endif %}
    </div>
    {% if help_text %}
    <div class="form-text">{{ help_text }}</div>
    {% endif %}
</div>

{# ========== FALLBACK (tipo não reconhecido) ========== #}
{% else %}
<div class="{{ wrapper_class }}">
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle"></i> Tipo de campo '{{ type }}' não suportado pela macro field().
    </div>
</div>
{% endif %}

{% endmacro %}