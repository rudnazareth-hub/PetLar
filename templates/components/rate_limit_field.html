{#
Componente para campos de configuração de rate limit.

Renderiza um par de campos (max requisições + minutos) lado a lado
com labels claros e validação.

Parâmetros:
  - prefixo: Prefixo do nome da configuração (ex: "rate_limit_login")
  - label: Label descritiva (ex: "Login")
  - max_atual: Valor atual de max_tentativas
  - minutos_atuais: Valor atual de janela_minutos
  - max_recomendado: Valor recomendado para max (opcional)
  - minutos_recomendados: Valor recomendado para minutos (opcional)
  - descricao: Descrição adicional (opcional)
  - erros: Dict com erros de validação (opcional)

Exemplo de uso:
  {% from 'components/rate_limit_field.html' import rate_limit_field %}
  {{ rate_limit_field(
      prefixo='rate_limit_login',
      label='Login',
      max_atual=5,
      minutos_atuais=5,
      max_recomendado=5,
      minutos_recomendados=5,
      descricao='Limite de tentativas de login por IP',
      erros=erros
  ) }}
#}

{% macro rate_limit_field(prefixo, label, max_atual, minutos_atuais, max_recomendado=None, minutos_recomendados=None, descricao=None, erros={}) %}
<div class="card mb-3">
    <div class="card-body">
        <h6 class="card-subtitle mb-3 text-muted">{{ label }}</h6>

        {% if descricao %}
        <p class="small text-muted mb-3">{{ descricao }}</p>
        {% endif %}

        <div class="row g-2">
            <!-- Campo: Máximo de requisições -->
            <div class="col-md-6">
                <label for="{{ prefixo }}_max" class="form-label">
                    Máximo de requisições
                    {% if max_recomendado %}
                    <span class="badge bg-secondary ms-1"
                          data-bs-toggle="tooltip"
                          title="Valor recomendado: {{ max_recomendado }}">
                        <i class="bi bi-info-circle"></i>
                    </span>
                    {% endif %}
                </label>
                <input
                    type="number"
                    class="form-control {% if erros.get(prefixo + '_max') %}is-invalid{% endif %}"
                    id="{{ prefixo }}_max"
                    name="{{ prefixo }}_max"
                    value="{{ max_atual }}"
                    min="1"
                    max="1000"
                    required
                    aria-describedby="{{ prefixo }}_max_help">
                <div class="form-text" id="{{ prefixo }}_max_help">
                    Número máximo de operações permitidas
                </div>
                {% if erros.get(prefixo + '_max') %}
                <div class="invalid-feedback d-block">
                    {{ erros[prefixo + '_max'] }}
                </div>
                {% endif %}
            </div>

            <!-- Campo: Janela de tempo em minutos -->
            <div class="col-md-6">
                <label for="{{ prefixo }}_minutos" class="form-label">
                    A cada (minutos)
                    {% if minutos_recomendados %}
                    <span class="badge bg-secondary ms-1"
                          data-bs-toggle="tooltip"
                          title="Valor recomendado: {{ minutos_recomendados }}">
                        <i class="bi bi-info-circle"></i>
                    </span>
                    {% endif %}
                </label>
                <input
                    type="number"
                    class="form-control {% if erros.get(prefixo + '_minutos') %}is-invalid{% endif %}"
                    id="{{ prefixo }}_minutos"
                    name="{{ prefixo }}_minutos"
                    value="{{ minutos_atuais }}"
                    min="1"
                    max="1440"
                    required
                    aria-describedby="{{ prefixo }}_minutos_help">
                <div class="form-text" id="{{ prefixo }}_minutos_help">
                    Período de tempo em minutos
                </div>
                {% if erros.get(prefixo + '_minutos') %}
                <div class="invalid-feedback d-block">
                    {{ erros[prefixo + '_minutos'] }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Interpretação clara -->
        <div class="alert alert-info mt-3 mb-0 d-flex align-items-center">
            <i class="bi bi-speedometer2 me-2"></i>
            <span class="rate-limit-summary">
                <strong>Limite atual:</strong>
                <span id="{{ prefixo }}_summary">{{ max_atual }} requisições a cada {{ minutos_atuais }} minuto(s)</span>
            </span>
        </div>
    </div>
</div>

<script>
// Atualizar summary quando campos mudarem
(function() {
    const maxInput = document.getElementById('{{ prefixo }}_max');
    const minutosInput = document.getElementById('{{ prefixo }}_minutos');
    const summary = document.getElementById('{{ prefixo }}_summary');

    if (maxInput && minutosInput && summary) {
        function updateSummary() {
            const max = maxInput.value || '0';
            const minutos = minutosInput.value || '0';
            summary.textContent = `${max} requisições a cada ${minutos} minuto(s)`;
        }

        maxInput.addEventListener('input', updateSummary);
        minutosInput.addEventListener('input', updateSummary);
    }
})();
</script>
{% endmacro %}
